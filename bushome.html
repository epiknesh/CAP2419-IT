<!DOCTYPE html>    
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>BusMate - Home</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/bushome-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid d-flex align-items-center">
            <img src="img/BusMateLogo_White.png" alt="BusMate Logo" style="width: 90px; height: auto;">
            <img src="img/BusMateLogo.png" alt="BusMate Logo" style="width: 90px; height: auto;">
            <a class="navbar-brand ms-2">Hello,<br>BusMate!</a>
            <div class="notification-tab ms-auto" onmouseover="showDropdown()" onmouseout="hideDropdown()">
                <img id="profile-picture1" class="profile-img" src="img/busicon.png" alt="Profile">
                <div id="dropdown-menu" class="dropdown-content">
                    <a href="bushome.html">Home</a>
                    <a href="busrecents.html">Recents</a>
                    <a href="buses.html">Buses Location & Schedule</a>
                    <a href="businfo.html">Buses Information</a>
                </div>
            </div>
        </div>
    </nav>  

    <!-- Container for Search Bar, Location Info, and Map -->
    <div class="content-container">
        <!-- Search Bar -->
        <input type="text" class="search-bar" placeholder="Search for Bus Number">
        
        <!-- Location Info -->
        <div class="location-label">CURRENT LOCATION</div>
        <p class="location" id="location-coordinates">Fetching location...</p>
        <p class="address" id="address">Fetching address...</p>
        
        <!-- Map -->
        <div id="map" style="height: 500px;"></div>
    </div>

    <!-- Footer -->
    <div class="footer">&copy; 2025 BusMate. All Rights Reserved.</div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
const apiKey = "5b3ce3597851110001cf6248ef6021b6165e4d53935261fad6ed7e96"; // OpenRouteService API key
const profile = "driving-car"; // Travel mode

let userCoords = null; // Store user location
let busMarkers = {}; // Store bus markers

document.addEventListener("DOMContentLoaded", function () {
    function getLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                  //userCoords = [position.coords.longitude, position.coords.latitude]; // Store user location
                    userCoords = [121.02310781010837, 14.553511800681616]; // Hardcoded user location
                    document.getElementById("location-coordinates").textContent = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;

            

                    // Reverse Geocoding to get user address
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("address").textContent = data.display_name;
                        })
                        .catch(error => console.error("‚ùå Error fetching address:", error));

                    // Add user marker
                    L.marker([position.coords.latitude, position.coords.longitude]).addTo(map)
                        .bindPopup("üìç You are here").openPopup();
                    map.setView([position.coords.latitude, position.coords.longitude], 15);
                },
                function (error) {
                    document.getElementById("location-coordinates").textContent = "Unable to fetch location.";
                    console.error("‚ùå Geolocation error:", error);
                }
            );
        } else {
            document.getElementById("location-coordinates").textContent = "Geolocation is not supported.";
        }
    }

    getLocation(); // Get user's current location
});

// Initialize Map
let map = L.map("map").setView([14.5995, 120.9842], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

// Fetch and Update Bus Locations
function updateBusLocations() {
    fetch("http://localhost:8000/api/get_locations") // API for bus locations
        .then(response => response.json())
        .then(data => {
            Object.keys(data).forEach(bus_id => {
                const { latitude, longitude } = data[bus_id];
                const busCoords = [longitude, latitude]; // Format for ORS API

                if (busMarkers[bus_id]) {
                    busMarkers[bus_id].setLatLng([latitude, longitude]);
                } else {
                    busMarkers[bus_id] = L.marker([latitude, longitude]).addTo(map)
                        .bindPopup(`üöå Bus ${bus_id}`)
                        .on("click", function () {
                            if (userCoords) {
                                console.log(userCoords);
                                calculateETA(busCoords, userCoords).then(eta => {
                                    if (eta !== null) {
                                        console.log(`ETA for Bus ${bus_id}: ${eta} minutes`);
                                        alert(`üöå Bus ${bus_id} ETA: ${eta} minutes (via designated route)`);
                                    } else {
                                        alert("Could not calculate ETA.");
                                    }
                                });
                            } else {
                                alert("User location not found. Please enable location services.");
                            }
                        });
                }
            });
        })
        .catch(error => console.error("‚ùå Error fetching bus data:", error));
}

// Fetch new bus locations every 5 seconds
setInterval(updateBusLocations, 5000);

async function calculateETA(busCoords, userCoords) {
    const waypoints = [
        { coords: [121.0453548, 14.4165861], name: "üìç Starmall Alabang" },
        { coords: [121.0439273, 14.4221584], name: "üõ£Ô∏è Alabang Viaduct (Northbound)" },
        { coords: [121.0432, 14.4482], name: "üõ£Ô∏è Filinvest Entrance to SLEX" },
        { coords: [121.0391973, 14.4560063], name: "üõ£Ô∏è Sucat Exit (Main Road)" },
        { coords: [121.0420633, 14.4874818], name: "üõ£Ô∏è Bicutan Entry (Skyway Access)" },
        { coords: [121.016892, 14.540315], name: "üõ£Ô∏è Magallanes Interchange (Fixed)" },
        { coords: [121.026021, 14.547193], name: "üõ£Ô∏è EDSA - Ayala Ave Exit" },
        { coords: [121.025818, 14.549893], name: "üõ£Ô∏è Glorietta (Main Road)" },
        { coords: [121.026577, 14.548915], name: "üõ£Ô∏è MRT Ayala Station (Near SM Makati)" },
        { coords: [14.550218982310554, 121.02789195667842], name: "üìç One Ayala (Final Destination)" }
    ];


    // üõë Find closest bus stop to the user
    let closestStop = waypoints.reduce((closest, stop) => {
        return getDistance(userCoords, stop.coords) < getDistance(userCoords, closest.coords) ? stop : closest;
    });

    let walkingDistanceKm = getDistance(userCoords, closestStop.coords); // Distance in km
    let walkingDistanceMeters = Math.round(walkingDistanceKm * 1000); // Convert km to meters
    let walkingTimeMinutes = Math.round((walkingDistanceKm / 5) * 60); // Assuming 5 km/h walking speed

    console.log(`üìç User Location: ${userCoords}`);
    console.log(`üöè Nearest Bus Stop: ${closestStop.name}`);
    console.log(`üö∂ Walking Distance: ${walkingDistanceKm.toFixed(2)} km (~${walkingTimeMinutes} min, ${walkingDistanceMeters}m)`);

    // üõë If user is more than 10 min away, provide driving ETA instead of walking
    if (walkingTimeMinutes > 10) {
        const driveETA = await getDrivingETA(userCoords, closestStop.coords);
        alert(`‚ö†Ô∏è You are out of the bus's route.\nüöè Nearest stop: ${closestStop.name}\nüöó Driving distance: ~${driveETA} min (${walkingDistanceKm.toFixed(2)} km away)`);
        return null;
    }

    // ‚úÖ If user is within 10 min, inform them and calculate bus ETA
    alert(`üöè Nearest stop: ${closestStop.name}\nüö∂ Walking distance: ~${walkingTimeMinutes} min (${walkingDistanceMeters}m)`);

    const coordinates = [busCoords, closestStop.coords];

    const url = `https://api.openrouteservice.org/v2/directions/driving-car`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": apiKey
            },
            body: JSON.stringify({
                coordinates: coordinates,
                format: "json"
            })
        });

        const data = await response.json();

        if (data.error) {
            console.error("‚ùå ORS Error:", data.error);
            alert(`üö® Route Error: ${data.error.message}`);
            return null;
        }

        if (data.routes && data.routes.length > 0) {
            const etaSeconds = data.routes[0].summary.duration;
            const etaMinutes = Math.round(etaSeconds / 60);

            alert(`üöè Nearest stop: ${closestStop.name}\nüö∂ Walking distance: ~${walkingTimeMinutes} min (${walkingDistanceMeters}m)\nüöå Bus ETA: ~${etaMinutes} min`);
            console.log(`‚è≥ ETA to nearest stop: ${etaMinutes} minutes`);
            return etaMinutes;
        } else {
            console.error("‚ùå No route found. Response:", data);
            alert("‚ùå No route found.");
            return null;
        }
    } catch (error) {
        console.error("‚ùå Error fetching ETA:", error);
        return null;
    }
}

// Function to calculate the driving ETA using OpenRouteService
async function getDrivingETA(startCoords, endCoords) {
    const url = `https://api.openrouteservice.org/v2/directions/driving-car`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": apiKey
            },
            body: JSON.stringify({
                coordinates: [startCoords, endCoords],
                format: "json"
            })
        });

        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
            return Math.round(data.routes[0].summary.duration / 60); // Convert seconds to minutes
        } else {
            console.error("‚ùå No driving route found.");
            return "N/A";
        }
    } catch (error) {
        console.error("‚ùå Error fetching driving ETA:", error);
        return "N/A";
    }
}

// Function to calculate the distance between two coordinates
function getDistance(coord1, coord2) {
    const [lon1, lat1] = coord1;
    const [lon2, lat2] = coord2;
    const R = 6371; // Radius of the Earth in km
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in km
}



        document.addEventListener("DOMContentLoaded", function () {
            const dropdown = document.getElementById("dropdown-menu");
            const notificationTab = document.querySelector(".notification-tab");

            notificationTab.addEventListener("mouseover", function () {
               dropdown.style.display = "block";
           });

           dropdown.addEventListener("mouseleave", function () {
               dropdown.style.display = "none";
            });
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
