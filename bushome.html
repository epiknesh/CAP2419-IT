<!DOCTYPE html>    
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>BusMate - Home</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/bushome-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid d-flex align-items-center">
            <!-- Logo and Text Wrapped in a Flex Container -->
            <div class="d-flex align-items-center">
                <img src="img/BusMateLogo_White.png" alt="BusMate Logo" style="width: 90px; height: auto;">
                <img src="img/BusMateLogo.png" alt="BusMate Logo" style="width: 90px; height: auto;">
                <a class="navbar-brand ms-2" style="white-space: nowrap; font-size: 40px;">Hello, BusMate!</a>
            </div>
        </div>
    </nav>
    
    <!-- Container for Search Bar, Location Info, and Map -->
    <div class="content-container">
        <!-- Search Bar -->
        <input type="text" class="search-bar" placeholder="Search for Bus Number">
        
        <!-- Location Info -->
        <div class="location-label">CURRENT LOCATION</div>
        <p class="address" id="address">Fetching address...</p>
        
        <!-- Map -->
        <div id="map" style="height: 500px;"></div>

        <div class="title-divider"></div>

        <!-- Bus Tracker Title -->
<h2 class="bus-tracker-title">üöå Find Your Ride in Real-Time!</h2>

<!-- Bus Cards Container -->
<div class="container mt-4">
    <div class="row row-cols-1 row-cols-md-3 g-4" id="bus-cards-container">
        <!-- Bus cards will be dynamically inserted here -->
    </div>
</div>


    <!-- ETA Popup Modal -->
<div class="modal fade" id="etaModal" tabindex="-1" aria-labelledby="etaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="etaModalLabel">Estimated Time of Arrival</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="etaModalBody">
                <!-- ETA Information will be inserted here dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Footer -->
    <div class="footer">&copy; 2025 BusMate. All Rights Reserved.</div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="js/server.js"></script>
    <script>
        
const apiKey = "5b3ce3597851110001cf6248ef6021b6165e4d53935261fad6ed7e96"; // OpenRouteService API key
const profile = "driving-car"; // Travel mode

let userCoords = null; // Store user location
let busMarkers = {}; // Store bus markers

document.addEventListener("DOMContentLoaded", function () {
    
    function getLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
             // userCoords = [position.coords.longitude, position.coords.latitude]; // Store user location
                   userCoords = [121.02310781010837, 14.553511800681616]; // Hardcoded user location
                    // Reverse Geocoding to get user address
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("address").textContent = data.display_name;
                        })
                        .catch(error => console.error("‚ùå Error fetching address:", error));

                    // Add user marker
                    L.marker([position.coords.latitude, position.coords.longitude]).addTo(map)
                        .bindPopup("üìç You are here").openPopup();
                    map.setView([position.coords.latitude, position.coords.longitude], 15);
                },
                function (error) {
                    console.error("‚ùå Geolocation error:", error);
                }
            );
        } else {
            document.getElementById("address").textContent = "Geolocation is not supported.";
        }
    }

    getLocation(); // Get user's current location
    loadBusCards();
   
});



async function loadBusCards() {
    const busCardsContainer = document.getElementById("bus-cards-container");

    try {
        // Fetch bus locations
        const locationResponse = await fetch("http://localhost:8000/api/get_locations");
        const locationData = await locationResponse.json();

        // Fetch bus details (plate number, capacity, etc.)
        const busResponse = await fetch("http://localhost:3000/buses");
        const busData = await busResponse.json();

        const capacityResponse = await fetch('http://localhost:3000/capacity');
const capacities = await capacityResponse.json();

    const dispatchResponse = await fetch('http://localhost:3000/dispatch');
    const dispatches = await dispatchResponse.json();

console.log("üìä Raw Capacities Data:", capacities); // Log all capacity data received

const latestCapacities = capacities.reduce((acc, entry) => {
    const busID = entry.busID;
    if (!acc[busID] || new Date(entry.date) > new Date(acc[busID].date)) {
        acc[busID] = entry;
    }
    return acc;
}, {});

console.log("üìÖ Latest Capacities by Bus:", latestCapacities); // Log filtered latest capacities per bus

function getBusCapacity(busID) {
    const entry = latestCapacities[busID]; // Retrieve the specific bus's capacity entry
    if (!entry) {
        console.warn(`‚ö†Ô∏è No capacity data found for Bus ${busID}`);
        return { percentage: 0, capacityClass: "bg-secondary" }; // Default values
    }

    const maxCapacity = 60;
    let percentage = (entry.capacity / maxCapacity) * 100;
    percentage = parseFloat(percentage.toFixed(2)); // Ensure at most 2 decimal places
    const capacityClass = percentage > 75 ? "bg-danger" : percentage > 40 ? "bg-warning" : "bg-success";

    console.log(`üöå Bus ${busID}: Capacity ${entry.capacity}/${maxCapacity} (${percentage.toFixed(2)}%) - Class: ${capacityClass}`);

    return { percentage, capacityClass };
}



        // Clear existing content before adding new bus cards
        busCardsContainer.innerHTML = "";

        // Loop through each bus retrieved from locations API
        Object.keys(locationData).forEach(busKey => {
            const busCoords = locationData[busKey];

            // Convert "bus1" to just 1
            const numericBusID = parseInt(busKey.replace("bus", ""), 10);
            const bus = busData.find(b => b.busID === numericBusID);
            

            const dispatch = dispatches.find(d => d.busID === numericBusID);

            let formattedNextDispatch = "N/A"; // Default value if no data
        let stopA = "N/A";
        let stopB = "N/A";

        if (dispatch && dispatch.nextDispatch) {
            const nextDispatchDate = new Date(dispatch.nextDispatch);

            // Format time in 12-hour AM/PM format
            let hours = nextDispatchDate.getHours();
            let minutes = nextDispatchDate.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';

            hours = hours % 12 || 12; // Convert to 12-hour format
            minutes = minutes.toString().padStart(2, '0'); // Ensure two-digit minutes

            formattedNextDispatch = `${hours}:${minutes} ${ampm}`;

            // üïí Calculate Stop A time (30 mins after leaving terminal)
            const stopADate = new Date(nextDispatchDate.getTime() + 30 * 60000);
            let stopAHours = stopADate.getHours() % 12 || 12;
            let stopAMinutes = stopADate.getMinutes().toString().padStart(2, '0');
            let stopAAPM = stopADate.getHours() >= 12 ? 'PM' : 'AM';
            stopA = `${stopAHours}:${stopAMinutes} ${stopAAPM}`;

            // üïí Calculate Stop B time (30 mins after Stop A)
            const stopBDate = new Date(stopADate.getTime() + 30 * 60000);
            let stopBHours = stopBDate.getHours() % 12 || 12;
            let stopBMinutes = stopBDate.getMinutes().toString().padStart(2, '0');
            let stopBAPM = stopBDate.getHours() >= 12 ? 'PM' : 'AM';
            stopB = `${stopBHours}:${stopBMinutes} ${stopBAPM}`;
        }

            const { percentage, capacityClass } = getBusCapacity(numericBusID);

            if (!bus) return; // Skip if bus details are not found

            const currentBusCoords = busCoords.latitude + ", " + busCoords.longitude;
        

            // Create bus card HTML
           // Create bus card HTML
const busCard = `
    <div class="col-md-6 d-block d-md-inline">
        <div class="bus-card">
            <!-- Bus Information Row -->
            <div class="bus-info">
                <div class="bus-number">BUS # ${bus.busID}</div>
                <div class="plate-number">Plate: ${bus.plateNumber}</div>
            </div>

            <!-- Passenger Capacity -->
            <div class="people-capacity mt-3 mx-4">
                <div class="d-flex justify-content-between align-items-center">
                    <span>üë§ Passenger Capacity</span>
                    <span id="capacity-percentage">${percentage}%</span>
                </div>
                <div class="progress mt-2">
                    <div class="progress-bar ${capacityClass}" style="width:${percentage}%;" role="progressbar"></div>
                </div>
            </div>

            <div id="latest-loc-${bus.busID}" style="margin: 10px 0; text-align: center; font-weight: bold;">
                Fetching location...
            </div>

            <div id="map-${bus.busID}" style="height: 200px; border-radius: 10px;"></div>

            <!-- üÜï Generate ETA Button -->
            <button class="view-schedule-btn" 
                onclick="calculateETA([${busCoords.longitude}, ${busCoords.latitude}], userCoords, 'bus${numericBusID}')">
                Get Bus ETA
            </button>

          

            <!-- View Schedule Button -->
            <button class="view-schedule-btn" onclick="toggleSchedule('schedule-${bus.busID}')">View Schedule</button>

            <!-- üöå Schedule inside bus card -->
            <div id="schedule-${bus.busID}" class="schedule-card" style="display: none;">
                <div class="header">üöå Bus #${bus.busID} Schedule</div>
                <div class="schedule-item"><span>${formattedNextDispatch}</span> <span>Terminal Departure</span></div>
                <div class="schedule-item"><span>~${stopA}</span> <span>Arrives at End Destination</span></div>
                <div class="schedule-item"><span>~${stopB}</span> <span>Arrives at Terminal Return</span></div>
            </div>
        </div>
    </div>
`;

       

            // Append to the container
            busCardsContainer.innerHTML += busCard;

                    setTimeout(() => {
            const mapElement = document.getElementById(`map-${bus.busID}`);
            if (mapElement) {
                const busMap = L.map(mapElement).setView([busCoords.latitude, busCoords.longitude], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(busMap);
            }
        }, 100);

        });

    } catch (error) {
        console.error("‚ùå Error fetching bus data:", error);
    }
}

// Initialize Map
let map = L.map("map").setView([14.5995, 120.9842], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

// Fetch and Update Bus Locations
function updateBusLocations() {
    fetch("http://localhost:8000/api/get_locations") // API for bus locations
        .then(response => response.json())
        .then(data => {
            Object.keys(data).forEach(bus_id => {
                const { latitude, longitude } = data[bus_id];
                const busCoords = [longitude, latitude]; // Format for ORS API

                // üöå Define a custom bus icon
                const busIcon = L.icon({
                    iconUrl: 'img/bus-icon.png', // Path to your custom icon
                    iconSize: [45.875, 55.375], // Width and height of the icon
                    iconAnchor: [22.9, 55.375], // Point of the icon that corresponds to marker‚Äôs location
                    popupAnchor: [0, -35] // Offset for the popup
                });

                if (busMarkers[bus_id]) {
                    busMarkers[bus_id].setLatLng([latitude, longitude]);
                } else {
                    busMarkers[bus_id] = L.marker([latitude, longitude], { icon: busIcon }) // üÜï Apply custom icon
                        .addTo(map)
                        .bindPopup(`üöå ${bus_id}`)
                        .on("click", function () {
                            if (userCoords) {
                                console.log(userCoords);
                                calculateETA(busCoords, userCoords, bus_id).then(eta => {
                                    if (eta !== null) {
                                        console.log(`ETA for Bus ${bus_id}: ${eta} minutes`);
                                    } 
                                });
                            } else {
                                alert("User location not found. Please enable location services.");
                            }
                        });
                }
            });
        })
        .catch(error => console.error("‚ùå Error fetching bus data:", error));
}


// Fetch new bus locations every 5 seconds
setInterval(updateBusLocations, 5000);

function showPopupMessage(message) {
    document.getElementById("etaModalBody").innerHTML = message;
    let etaModal = new bootstrap.Modal(document.getElementById("etaModal"));
    etaModal.show();
}

async function calculateETA(busCoords, userCoords, busID) {

    console.log(`üöå Bus ID: ${busID}`);
    console.log(`üìç Bus Coordinates:`, busCoords);
    console.log(`üìç User Coordinates:`, userCoords);

    if (!busCoords || !userCoords) {
        console.error("‚ùå Missing coordinates. Bus or user location is undefined.");
        alert("Unable to generate ETA. Location data missing.");
        return;
    }
    const waypoints = [
        { coords: [121.0453548, 14.4165861], name: "üìç Starmall Alabang" },
        { coords: [121.0439273, 14.4221584], name: "üõ£Ô∏è Alabang Viaduct (Northbound)" },
        { coords: [121.0432, 14.4482], name: "üõ£Ô∏è Filinvest Entrance to SLEX" },
        { coords: [121.0391973, 14.4560063], name: "üõ£Ô∏è Sucat Exit (Main Road)" },
        { coords: [121.0420633, 14.4874818], name: "üõ£Ô∏è Bicutan Entry (Skyway Access)" },
        { coords: [121.016892, 14.540315], name: "üõ£Ô∏è Magallanes Interchange (Fixed)" },
        { coords: [121.026021, 14.547193], name: "üõ£Ô∏è EDSA - Ayala Ave Exit" },
        { coords: [121.025818, 14.549893], name: "üõ£Ô∏è Glorietta (Main Road)" },
        { coords: [121.026577, 14.548915], name: "üõ£Ô∏è MRT Ayala Station (Near SM Makati)" },
        { coords: [14.550218982310554, 121.02789195667842], name: "üìç One Ayala (Final Destination)" }
    ];

    let plateNumber = "Unknown Plate";
    try {
    const busResponse = await fetch(`http://localhost:3000/buses`);
    const busData = await busResponse.json();

    // Log all bus IDs and plate numbers retrieved
    console.log("üöç Retrieved Buses from Database:");
    busData.forEach(bus => console.log(`üÜî Bus ID: ${bus.busID}, üîñ Plate: ${bus.plateNumber}`));

    // Convert "bus1" to just 1
    const numericBusID = parseInt(busID.replace("bus", ""), 10);
    console.log(`üîç Searching for Bus ID: ${numericBusID}`);

    // Find matching bus
    const bus = busData.find(b => b.busID === numericBusID);
    
    if (bus) {
        plateNumber = bus.plateNumber;
        console.log(`‚úÖ Found Bus: üÜî ${bus.busID}, üîñ Plate: ${plateNumber}`);
    } else {
        console.log(`‚ùå No bus found with ID: ${numericBusID}`);
    }
} catch (error) {
    console.error("‚ùå Error fetching bus details:", error);
}

    // üõë Find closest bus stop to the user
    let closestStop = waypoints.reduce((closest, stop) => {
        return getDistance(userCoords, stop.coords) < getDistance(userCoords, closest.coords) ? stop : closest;
    });

    let walkingDistanceKm = getDistance(userCoords, closestStop.coords);
    let walkingDistanceMeters = Math.round(walkingDistanceKm * 1000);
    let walkingTimeMinutes = Math.round((walkingDistanceKm / 5) * 60);

    console.log(`üìç User Location: ${userCoords}`);
    console.log(`üöè Nearest Bus Stop: ${closestStop.name}`);
    console.log(`üö∂ Walking Distance: ${walkingDistanceKm.toFixed(2)} km (~${walkingTimeMinutes} min, ${walkingDistanceMeters}m)`);

    // üõë If user is more than 10 min away, provide driving ETA instead of walking
    if (walkingTimeMinutes > 10) {
        const driveETA = await getDrivingETA(userCoords, closestStop.coords);
        showPopupMessage(`
            ‚ö†Ô∏è You are out of the bus's route.<br>
            üöè Nearest stop: <strong>${closestStop.name}</strong><br>
            üöó Driving distance: ~<strong>${driveETA} min</strong> (${walkingDistanceKm.toFixed(2)} km away)
        `);
        return null;
    }


    const coordinates = [busCoords, closestStop.coords];
    const url = `https://api.openrouteservice.org/v2/directions/driving-car`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": apiKey
            },
            body: JSON.stringify({
                coordinates: coordinates,
                format: "json"
            })
        });

        const data = await response.json();

        if (data.error) {
            console.error("‚ùå ORS Error:", data.error);
            showPopupMessage(`üö® Route Error: ${data.error.message}`);
            return null;
        }

        if (data.routes && data.routes.length > 0) {
            const etaSeconds = data.routes[0].summary.duration;
            const etaMinutes = Math.round(etaSeconds / 60);

            showPopupMessage(`
                üöè Nearest stop: <strong>${closestStop.name}</strong><br>
                üö∂ Walking distance: ~<strong>${walkingTimeMinutes} min</strong> (${walkingDistanceMeters}m)<br>
                üöå Bus Plate Number: <strong> ${plateNumber}</strong><br>
                üïí ETA to Stop: ~<strong>${etaMinutes} min</strong>
            `);
            console.log(`‚è≥ ETA to nearest stop: ${etaMinutes} minutes`);
            return etaMinutes;
        } else {
            console.error("‚ùå No route found. Response:", data);
            showPopupMessage("‚ùå No route found.");
            return null;
        }
    } catch (error) {
        console.error("‚ùå Error fetching ETA:", error);
        showPopupMessage("‚ùå Error fetching ETA.");
        return null;
    }
}


// Function to calculate the driving ETA using OpenRouteService
async function getDrivingETA(startCoords, endCoords) {
    const url = `https://api.openrouteservice.org/v2/directions/driving-car`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": apiKey
            },
            body: JSON.stringify({
                coordinates: [startCoords, endCoords],
                format: "json"
            })
        });

        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
            return Math.round(data.routes[0].summary.duration / 60); // Convert seconds to minutes
        } else {
            console.error("‚ùå No driving route found.");
            return "N/A";
        }
    } catch (error) {
        console.error("‚ùå Error fetching driving ETA:", error);
        return "N/A";
    }
}

// Function to calculate the distance between two coordinates
    function getDistance(coord1, coord2) {
        const [lon1, lat1] = coord1;
        const [lon2, lat2] = coord2;
        const R = 6371; // Radius of the Earth in km
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
    }

    document.addEventListener("DOMContentLoaded", function () {
        const searchBar = document.querySelector(".search-bar");

        searchBar.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                searchForBus();
            }
        });

        function searchForBus() {
            const searchQuery = searchBar.value.trim().toLowerCase();
            let busCard = null;

            if (searchQuery === "bus 1" || searchQuery === "1") {
                busCard = document.querySelector(".bus-card:nth-of-type(1)");
            } else if (searchQuery === "bus 2" || searchQuery === "2") {
                busCard = document.querySelector(".bus-card:nth-of-type(2)");
            } else {
                alert("Bus not found. Please enter a valid bus number.");
                return;
            }

            if (busCard) {
                // Scroll to the bus card smoothly
                busCard.scrollIntoView({ behavior: "smooth" });

                // Add the pop effect
                busCard.classList.add("pop-effect");

                // Remove the effect after 3 seconds
                setTimeout(() => {
                    busCard.classList.remove("pop-effect");
                }, 3000);
            }
        }
    });





        function updateBusLocationBuses() {
    fetch("http://localhost:8000/api/get_locations")
        .then(response => response.json())
        .then(data => {
            console.log(data);
            Object.keys(data).forEach(busKey => {
                const busCoords = data[busKey];
                console.log(`üîÑ Iterating: ${busKey}`);
console.log(`üìå Bus Coordinates:`, data[busKey]);
                
               

                // Convert "bus1" to numeric bus ID (e.g., "bus1" -> 1)
                const numericBusID = parseInt(busKey.replace("bus", ""), 10);

                console.log(`üîç Calling updateMapBuses with:`);
console.log(`   - Map ID: map-${numericBusID}`);
console.log(`   - Location ID: latest-loc-${numericBusID}`);
console.log(`   - Bus Key: ${busKey}`);

                // Dynamically update map and location
               updateMapBuses(`map-${numericBusID}`, busKey, busCoords, `latest-loc-${numericBusID}`);
            });
        })
        .catch(error => console.error("‚ùå Error fetching bus data:", error));
}

// Store Leaflet map instances and markers
let busMaps = {};  // Object to store Leaflet maps per bus
let cardBusMarkers = {}; // Object to store markers per bus

function updateMapBuses(mapId, busId, busData, locElementId) {
    const { latitude, longitude } = busData;

    const mapContainer = document.getElementById(mapId);
    if (!mapContainer) {
        console.warn(`‚ö†Ô∏è Map container not found for ${busId}`);
        return;
    }

    // üöå Define a custom bus icon
    const busIcon = L.icon({
                    iconUrl: 'img/bus-icon.png', // Path to your custom icon
                    iconSize: [45.875, 55.375], // Width and height of the icon
                    iconAnchor: [22.9, 55.375], // Point of the icon that corresponds to marker‚Äôs location
                    popupAnchor: [0, -35] // Offset for the popup
                });


    // üõë Ensure previous map instance is removed before initializing a new one
    if (busMaps[busId]) {
        console.warn(`üõë Map for ${busId} already exists, updating location...`);

        // Update marker position if map already exists
        if (cardBusMarkers[busId]) {
            cardBusMarkers[busId].setLatLng([latitude, longitude]);
        } else {
            cardBusMarkers[busId] = L.marker([latitude, longitude], { icon: busIcon }) // üÜï Use the custom icon
                .addTo(busMaps[busId])
                .bindPopup(`üöå Bus ${busId}`);
        }

        // Move map view to new bus location
        busMaps[busId].setView([latitude, longitude], 13);
        return; // Stop further execution
    }

    // üõë Forcefully remove any lingering Leaflet instance
    if (L.DomUtil.get(mapId) !== null) {
        L.DomUtil.get(mapId)._leaflet_id = null; // Reset Leaflet instance ID
    }

    // ‚úÖ Initialize the map only if it does not exist
    busMaps[busId] = L.map(mapId, { center: [latitude, longitude], zoom: 13 });

    // Add OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(busMaps[busId]);

    // Add marker using the custom bus icon
    cardBusMarkers[busId] = L.marker([latitude, longitude], { icon: busIcon }) // üÜï Use the custom icon
        .addTo(busMaps[busId])
        .bindPopup(`üöå Bus ${busId}`);

    // Reverse Geocode to get location name
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
        .then(response => response.json())
        .then(locationData => {
            let locationName = "Unknown Location";
            if (locationData.address) {
                const { road, suburb, city, state, country } = locationData.address;
                locationName = [road, suburb, city, state, country].filter(Boolean).join(", ");
            }

            // Update the corresponding location element
            const locElement = document.getElementById(locElementId);
            if (locElement) {
                locElement.textContent = locationName;
            } else {
                console.warn(`‚ö†Ô∏è Location element not found for ${busId}`);
            }
        })
        .catch(error => {
            console.error("‚ùå Error fetching location name:", error);
            const locElement = document.getElementById(locElementId);
            if (locElement) {
                locElement.textContent = "Location unavailable";
            }
        });
}


setInterval(updateBusLocationBuses, 5000);
        

        var map2 = L.map('map2').setView([51.505, -0.09], 13); // Dummy coordinates
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map2);


        function toggleSchedule(scheduleId) {
            let schedule = document.getElementById(scheduleId);

            // Hide all other schedules before showing the clicked one
            document.querySelectorAll('.schedule-card').forEach((el) => {
                if (el.id !== scheduleId) {
                    el.style.display = "none";
                    el.classList.remove("show");
                }
            });

            // Toggle the selected schedule
            if (schedule.style.display === "none" || schedule.style.display === "") {
                schedule.style.display = "flex";
                setTimeout(() => schedule.classList.add("show"), 10); // Add animation delay
            } else {
                schedule.classList.remove("show");
                setTimeout(() => (schedule.style.display = "none"), 300);
            }
        }

        

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
